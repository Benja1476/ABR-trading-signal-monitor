
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trading Signal Monitor — ARB/USDT (Live)</title>

    <style>
        :root {
            --primary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1e293b;
            --darker: #0f172a;
            --light: #f1f5f9;
            --gray: #94a3b8;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;}
        body{background:linear-gradient(135deg,var(--darker),#4c1d95,var(--darker));color:#fff;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        header{background:rgba(30,41,59,.85);backdrop-filter:blur(8px);border-radius:12px;padding:18px;margin-bottom:18px;border:1px solid rgba(148,163,184,.12)}
        .header-content{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
        .logo{display:flex;gap:12px;align-items:center}
        .logo-icon{width:44px;height:44;border-radius:10px;background:linear-gradient(45deg,var(--primary),#ec4899);display:flex;align-items:center;justify-content:center}
        .logo-text h1{font-size:20px;margin-bottom:2px}
        .logo-text p{color:var(--gray);font-size:13px}
        .status-pill{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:20px;background:rgba(239,68,68,.12)}
        .status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
        .status-pill.connected{background:rgba(16,185,129,.12)}
        .status-pill.connected .status-dot{background:var(--success)}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-bottom:14px}
        .card{background:rgba(15,23,42,.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.06)}
        .title{font-weight:700;margin-bottom:8px}
        .big{font-size:24px;font-weight:800}
        .progress-bar{height:8px;background:rgba(148,163,184,.12);border-radius:6px;overflow:hidden}
        .progress-fill{height:100%;transition:width .4s ease;border-radius:6px}
        .signals-list{max-height:320px;overflow:auto}
        .signal-entry{padding:10px;border-radius:10px;background:rgba(0,0,0,.06);margin-bottom:10px;border:1px solid rgba(148,163,184,.04)}
        .small-muted{color:var(--gray);font-size:13px}
        .kv{font-size:28px;font-weight:700}
        .slide-card{transition:all .25s ease}
        .slide-card:hover{transform:translateY(-6px)}
        @media (max-width:900px){ .header-content{flex-direction:column;align-items:flex-start} .grid{grid-template-columns:1fr} }
    </style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon" aria-hidden>
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
        </div>
        <div class="logo-text">
          <h1>Trading Signal Monitor</h1>
          <p>ARB/USDT — Live from Binance</p>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div id="connPill" class="status-pill"><div class="status-dot"></div><div id="connText">Connecting...</div></div>
        <div style="text-align:right">
          <div class="small-muted">Last update</div>
          <div id="currentTime" class="kv value-mono">--:--:--</div>
        </div>
      </div>
    </div>
  </header>

  <!-- top cards -->
  <div class="grid">
    <div class="card">
      <div class="title">Price (ARB/USDT)</div>
      <div class="big value-mono" id="currentPrice">0.000000</div>
      <div class="small-muted" id="priceChange">+0.00%</div>
    </div>

    <div class="card">
      <div class="title">EMA 55</div>
      <div class="big value-mono" id="ema55">0.000000</div>
      <div class="small-muted" id="emaStatus">-</div>
    </div>

    <div class="card">
      <div class="title">RSI (14)</div>
      <div class="big value-mono" id="rsiValue">0.00</div>
      <div class="small-muted" id="rsiStatus">Neutral</div>
    </div>

    <div class="card">
      <div class="title">Connection</div>
      <div class="big" id="connectionState">Offline</div>
      <div class="small-muted">Binance trade stream</div>
    </div>
  </div>

  <!-- Slides & signals -->
  <div style="display:grid;grid-template-columns:1fr 380px;gap:14px">
    <div>
      <div class="card">
        <div class="title">Signal Progress</div>

        <!-- Slide 1 -->
        <div class="slide-card card" style="margin-top:12px;background:linear-gradient(90deg,#0ea5a6,#0284c7);">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Slide 1 — Continue Up</strong><div class="small-muted">RSI>70 → RSI<30 → RSI>70 → price>EMA55 -> Long</div></div>
            <div id="slide1-status" class="small-muted">รอสัญญาณ</div>
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between"><span>ความคืบหน้า</span><span id="slide1-progress-text">0/4</span></div>
          <div class="progress-bar" style="margin-top:8px"><div id="slide1-progress" class="progress-fill" style="width:0%;background:#06b6d4"></div></div>
        </div>

        <!-- Slide 2 -->
        <div class="slide-card card" style="margin-top:12px;background:linear-gradient(90deg,#16a34a,#65a30d);">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Slide 2 — Reversal Down</strong><div class="small-muted">RSI>70 → RSI<30 → RSI>70 → price breaks above EMA then falls -> Short</div></div>
            <div id="slide2-status" class="small-muted">รอสัญญาณ</div>
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between"><span>ความคืบหน้า</span><span id="slide2-progress-text">0/4</span></div>
          <div class="progress-bar" style="margin-top:8px"><div id="slide2-progress" class="progress-fill" style="width:0%;background:#84cc16"></div></div>
          <div style="margin-top:8px" class="small-muted">Awaiting: <span id="slide2-awaiting">ไม่รอ</span></div>
        </div>

        <!-- Slide 3 -->
        <div class="slide-card card" style="margin-top:12px;background:linear-gradient(90deg,#7c3aed,#8b5cf6);">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Slide 3 — Continue Down</strong><div class="small-muted">RSI<30 → RSI>70 → RSI<30 → price<EMA55 -> Short</div></div>
            <div id="slide3-status" class="small-muted">รอสัญญาณ</div>
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between"><span>ความคืบหน้า</span><span id="slide3-progress-text">0/4</span></div>
          <div class="progress-bar" style="margin-top:8px"><div id="slide3-progress" class="progress-fill" style="width:0%;background:#8b5cf6"></div></div>
        </div>

        <!-- Slide 4 -->
        <div class="slide-card card" style="margin-top:12px;background:linear-gradient(90deg,#dc2626,#ef4444);">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Slide 4 — Reversal Up</strong><div class="small-muted">RSI<30 → RSI>70 → RSI<30 (no new low) → price breaks below EMA then rises -> Long</div></div>
            <div id="slide4-status" class="small-muted">รอสัญญาณ</div>
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between"><span>ความคืบหน้า</span><span id="slide4-progress-text">0/4</span></div>
          <div class="progress-bar" style="margin-top:8px"><div id="slide4-progress" class="progress-fill" style="width:0%;background:#fb7185"></div></div>
          <div style="margin-top:8px" class="small-muted">Awaiting: <span id="slide4-awaiting">ไม่รอ</span></div>
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Recent Signals</div>
        <div id="signalsList" class="signals-list" style="margin-top:10px">
          <div class="signal-entry small-muted" id="noSignals">Waiting for signals...</div>
        </div>
      </div>
    </div>

    <aside>
      <div class="card">
        <div class="title">Bot Status</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
          <div class="card" style="padding:10px;background:transparent;border:none">
            <div class="small-muted">Signals Sent</div>
            <div id="sentCount" class="kv">0</div>
          </div>
          <div class="card" style="padding:10px;background:transparent;border:none">
            <div class="small-muted">Waiting Price Break</div>
            <div id="waitingCount" class="kv">0</div>
          </div>
          <div class="card" style="padding:10px;background:transparent;border:none">
            <div class="small-muted">Active Patterns</div>
            <div id="activeCount" class="kv">0</div>
          </div>
          <div class="card" style="padding:10px;background:transparent;border:none">
            <div class="small-muted">Total Sides</div>
            <div class="kv">4</div>
          </div>
        </div>
      </div>
    </aside>
  </div>

</div>

<script>
/* ====== Config ====== */
const SYMBOL = 'ARBUSDT';
const KLINE_INTERVAL = '15m';
const KLINE_LIMIT = 500;
const EMA_PERIOD = 55;
const RSI_PERIOD = 14;

/* ====== State ====== */
let closes = [];            // historical close prices
let ema55 = null;
let avgGain = null, avgLoss = null;
let lastClose = null;
let rsiValue = null;
let prevRsi = null;
let prevPrice = null;

let slidesSteps = {1:[false,false,false,false],2:[false,false,false,false],3:[false,false,false,false],4:[false,false,false,false]};
let slidesSent = [];
let slide2_brokeAboveEMA = false;
let slide4_brokeBelowEMA = false;
let slide4_price_at_step1_low = null;
let slide1_price_at_step2_low = null;

/* ====== DOM helpers ====== */
const $ = id => document.getElementById(id);
function nowTime(){ return new Date().toLocaleTimeString('th-TH'); }
function setConn(connected){
  const pill = $('connPill');
  if(connected){ pill.classList.add('connected'); $('connText').innerText='Connected'; $('connectionState').innerText='Online'; $('connectionState').style.color='#10b981'; }
  else { pill.classList.remove('connected'); $('connText').innerText='Connecting...'; $('connectionState').innerText='Offline'; $('connectionState').style.color='#ef4444'; }
}

/* ====== Math helpers ====== */
function calcEMAFromArray(prices, period) {
  if (!prices || prices.length < period) return null;
  const k = 2 / (period + 1);
  let ema = prices.slice(0, period).reduce((a,b)=>a+b,0) / period;
  for (let i = period; i < prices.length; i++) {
    ema = prices[i] * k + ema * (1 - k);
  }
  return ema;
}
function calcInitialRSI(prices, period) {
  if (!prices || prices.length < period+1) return {avgGain:null,avgLoss:null,rsi:null};
  let gains=0, losses=0;
  const start = prices.length - period;
  for (let i=start; i<prices.length; i++){
    const ch = prices[i]-prices[i-1];
    if (ch>0) gains+=ch; else losses+=-ch;
  }
  const avgGainInit = gains/period;
  const avgLossInit = losses/period;
  const rs = avgLossInit===0?Infinity:(avgGainInit/avgLossInit);
  const rsi = avgLossInit===0?100:(100-(100/(1+rs)));
  return {avgGain:avgGainInit,avgLoss:avgLossInit,rsi};
}
function updateSmoothedRSI(prevAvgGain, prevAvgLoss, change, period){
  const gain = change>0?change:0;
  const loss = change<0?-change:0;
  const avgGainNew = (prevAvgGain*(period-1)+gain)/period;
  const avgLossNew = (prevAvgLoss*(period-1)+loss)/period;
  const rs = avgLossNew===0?Infinity:(avgGainNew/avgLossNew);
  const rsiNew = avgLossNew===0?100:(100-(100/(1+rs)));
  return {avgGainNew, avgLossNew, rsiNew};
}

/* ====== UI updates ====== */
function updateUI(price){
  $('currentTime').textContent = nowTime();
  $('currentPrice').textContent = price !== null ? Number(price).toFixed(6) : '--';
  $('ema55').textContent = ema55 !== null ? Number(ema55).toFixed(6) : '--';
  $('rsiValue').textContent = rsiValue !== null ? Number(rsiValue).toFixed(2) : '--';

  // RSI status
  if (rsiValue === null) { $('rsiStatus').innerText='Neutral'; $('rsiStatus').className='rsi-status'; }
  else if (rsiValue >= 70) { $('rsiStatus').innerText='Overbought'; $('rsiStatus').className='rsi-status rsi-overbought'; }
  else if (rsiValue <= 30) { $('rsiStatus').innerText='Oversold'; $('rsiStatus').className='rsi-status rsi-oversold'; }
  else { $('rsiStatus').innerText='Neutral'; $('rsiStatus').className='rsi-status rsi-neutral'; }

  // price change vs ema
  if (ema55 && price) {
    const pct = ((price-ema55)/ema55)*100;
    $('priceChange').innerText = (pct>=0?'+':'')+pct.toFixed(2)+'%';
    $('priceChange').style.color = pct>=0? '#10b981' : '#ef4444';
    $('emaStatus').innerText = price > ema55 ? 'Above Price' : 'Below Price';
    $('emaStatus').style.color = price > ema55 ? '#10b981' : '#ef4444';
  }

  // Slides UI
  for (let i=1;i<=4;i++){
    const stepCount = slidesSteps[i].filter(Boolean).length;
    $(`slide${i}-progress`).style.width = `${(stepCount/4)*100}%`;
    $(`slide${i}-progress-text`).innerText = `${stepCount}/4`;
    const sEl = $(`slide${i}-status`);
    if (slidesSent.includes(i)) {
      sEl.innerText = 'แจ้งแล้ว'; sEl.className='px-2 py-1 text-xs rounded-full bg-green-600';
    } else if (stepCount === 4) {
      sEl.innerText = 'พร้อมแจ้ง'; sEl.className='px-2 py-1 text-xs rounded-full bg-yellow-500';
    } else if (stepCount > 0) {
      sEl.innerText = 'กำลังรอ'; sEl.className='px-2 py-1 text-xs rounded-full bg-blue-500';
    } else {
      // default color kept in HTML
    }
  }

  // sent badges
  for (let i=1;i<=4;i++){
    const elid = `sent-slide-${i}`;
    const el = document.getElementById(elid);
    if (el) el.className = slidesSent.includes(i) ? 'px-4 py-2 rounded-full bg-green-600' : 'px-4 py-2 rounded-full bg-gray-700';
  }

  $('sentCount').innerText = slidesSent.length;
  $('waitingCount').innerText = (slide2_brokeAboveEMA?1:0) + (slide4_brokeBelowEMA?1:0);
  $('activeCount').innerText = Object.values(slidesSteps).flat().filter(Boolean).length;
}

/* ====== Signals list ====== */
function addSignal(type, slide, message) {
  const time = nowTime();
  const signal = { id: Date.now(), type, slide, message, time };
  // push to top
  const list = $('signalsList');
  // remove placeholder if exists
  const placeholder = $('noSignals');
  if (placeholder) placeholder.remove();

  const div = document.createElement('div');
  div.className = 'signal-entry';
  div.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${type}${slide?` (Slide ${slide})`:''}</strong><div class="small-muted">${time}</div></div>
                   <div style="margin-top:8px">${message}</div>`;
  list.prepend(div);
  // keep last 12
  while (list.children.length > 12) list.removeChild(list.lastChild);
}

/* ====== Record slide signal ====== */
function recordSlideSignal(slideNumber, sideType) {
  if (!slidesSent.includes(slideNumber)) {
    slidesSent.push(slideNumber);
    addSignal(sideType, slideNumber, `${sideType} entry signaled for Slide ${slideNumber}`);
    // TODO: place to send webhook / telegram / audible alert
  }
}

/* ====== Slide evaluation (per tick) ====== */
function evaluateSlideMachines(price, rsi, ema) {
  // keep prevRsi updated outside (we set prevRsi before update)
  // Slide 1
  if (!slidesSteps[1][0] && prevRsi !== null && prevRsi <= 70 && rsi !== null && rsi > 70) slidesSteps[1][0] = true;
  if (slidesSteps[1][0] && !slidesSteps[1][1] && prevRsi !== null && prevRsi >= 30 && rsi !== null && rsi < 30) { slidesSteps[1][1] = true; slide1_price_at_step2_low = price; }
  if (slidesSteps[1][1] && !slidesSteps[1][2] && prevRsi !== null && prevRsi <= 70 && rsi !== null && rsi > 70) slidesSteps[1][2] = true;
  if (slidesSteps[1][2] && !slidesSteps[1][3] && ema !== null && rsi !== null && price > ema && rsi > 70) { slidesSteps[1][3] = true; recordSlideSignal(1,'Long'); }

  // Slide 2
  if (!slidesSteps[2][0] && prevRsi !== null && prevRsi <= 70 && rsi !== null && rsi > 70) slidesSteps[2][0] = true;
  if (slidesSteps[2][0] && !slidesSteps[2][1] && prevRsi !== null && prevRsi >= 30 && rsi !== null && rsi < 30) slidesSteps[2][1] = true;
  if (slidesSteps[2][1] && !slidesSteps[2][2] && prevRsi !== null && prevRsi <= 70 && rsi !== null && rsi > 70) slidesSteps[2][2] = true;
  if (slidesSteps[2][2] && !slide2_brokeAboveEMA && ema !== null && price > ema) { slide2_brokeAboveEMA = true; $('slide2-awaiting').innerText='ทะลุ EMA ขึ้น (รอหลุด)'; $('slide2-awaiting').className='px-2 py-1 rounded bg-yellow-600'; }
  if (slidesSteps[2][2] && slide2_brokeAboveEMA && ema !== null && price < ema) { if(!slidesSteps[2][3]) { slidesSteps[2][3]=true; recordSlideSignal(2,'Short'); } }

  // Slide 3
  if (!slidesSteps[3][0] && prevRsi !== null && prevRsi >= 30 && rsi !== null && rsi < 30) slidesSteps[3][0] = true;
  if (slidesSteps[3][0] && !slidesSteps[3][1] && prevRsi !== null && prevRsi <= 70 && rsi !== null && rsi > 70) slidesSteps[3][1] = true;
  if (slidesSteps[3][1] && !slidesSteps[3][2] && prevRsi !== null && prevRsi >= 30 && rsi !== null && rsi < 30) slidesSteps[3][2] = true;
  if (slidesSteps[3][2] && !slidesSteps[3][3] && ema !== null && rsi !== null && price < ema && rsi < 30) { slidesSteps[3][3]=true; recordSlideSignal(3,'Short'); }

  // Slide 4
  if (!slidesSteps[4][0] && prevRsi !== null && prevRsi >= 30 && rsi !== null && rsi < 30) { slidesSteps[4][0]=true; slide4_price_at_step1_low = price; }
  if (slidesSteps[4][0] && !slidesSteps[4][1] && prevRsi !== null && prevRsi <= 70 && rsi !== null && rsi > 70) slidesSteps[4][1]=true;
  if (slidesSteps[4][1] && !slidesSteps[4][2] && prevRsi !== null && prevRsi >= 30 && rsi !== null && rsi < 30) {
    // no new low
    if (slide4_price_at_step1_low !== null && price >= slide4_price_at_step1_low) slidesSteps[4][2]=true;
  }
  if (slidesSteps[4][2] && !slide4_brokeBelowEMA && ema !== null && price < ema) { slide4_brokeBelowEMA = true; $('slide4-awaiting').innerText='ทะลุ EMA ลง (รอขึ้นกลับ)'; $('slide4-awaiting').className='px-2 py-1 rounded bg-yellow-600'; }
  if (slidesSteps[4][2] && slide4_brokeBelowEMA && ema !== null && price > ema) { if (!slidesSteps[4][3]) { slidesSteps[4][3]=true; recordSlideSignal(4,'Long'); } }

  // reset awaiting labels if conditions cleared
  if (!slide2_brokeAboveEMA) { $('slide2-awaiting').innerText='ไม่รอ'; $('slide2-awaiting').className='px-2 py-1 rounded bg-gray-700'; }
  if (!slide4_brokeBelowEMA) { $('slide4-awaiting').innerText='ไม่รอ'; $('slide4-awaiting').className='px-2 py-1 rounded bg-gray-700'; }
}

/* ====== Bootstrap: load historical klines ====== */
async function fetchKlines() {
  try {
    const url = `https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${KLINE_INTERVAL}&limit=${KLINE_LIMIT}`;
    const res = await fetch(url);
    const data = await res.json();
    closes = data.map(c => parseFloat(c[4])).filter(n => !isNaN(n));
    if (closes.length === 0) throw new Error('no data');

    // seed EMA
    if (closes.length >= EMA_PERIOD) ema55 = calcEMAFromArray(closes, EMA_PERIOD);
    // seed RSI
    if (closes.length >= RSI_PERIOD+1) {
      const r = calcInitialRSI(closes, RSI_PERIOD);
      avgGain = r.avgGain; avgLoss = r.avgLoss; rsiValue = r.rsi;
    }

    lastClose = closes[closes.length-1];
    prevPrice = lastClose;
    prevRsi = rsiValue;
    updateUI(lastClose);
  } catch (e) {
    console.error('fetchKlines error', e);
    $('connText').innerText = 'Failed to fetch klines';
    $('connPill').classList.remove('connected');
  }
}

/* ====== WebSocket trade stream ====== */
let ws = null;
let reconnectDelay = 2000;
function startWebSocket(){
  try {
    if (ws) { try{ ws.close(); }catch(e){} ws=null; }
    ws = new WebSocket(`wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@trade`);
    ws.onopen = ()=>{ setConn(true); $('connText').innerText='Connected (WebSocket)'; reconnectDelay=2000; };
    ws.onerror = (e)=>{ console.warn('ws error',e); $('connText').innerText='WebSocket error'; setConn(false); };
    ws.onclose = ()=>{ setConn(false); $('connText').innerText='Disconnected (reconnecting...)'; setTimeout(startWebSocket, reconnectDelay); reconnectDelay=Math.min(30000, reconnectDelay*1.5); };
    ws.onmessage = (evt)=>{
      try {
        const msg = JSON.parse(evt.data);
        const price = parseFloat(msg.p);
        if (isNaN(price)) return;

        // shift prev
        prevPrice = lastClose;
        prevRsi = rsiValue;

        // push to closes
        closes.push(price);
        if (closes.length > KLINE_LIMIT) closes.shift();

        // EMA update
        if (ema55 === null && closes.length >= EMA_PERIOD) ema55 = calcEMAFromArray(closes, EMA_PERIOD);
        else if (ema55 !== null) {
          const k = 2/(EMA_PERIOD+1);
          ema55 = price * k + ema55 * (1-k);
        }

        // RSI update
        if (avgGain === null || avgLoss === null) {
          if (closes.length >= RSI_PERIOD+1) {
            const r = calcInitialRSI(closes, RSI_PERIOD);
            avgGain = r.avgGain; avgLoss = r.avgLoss; rsiValue = r.rsi;
          } else rsiValue = null;
        } else {
          const change = lastClose !== null ? (price - lastClose) : 0;
          const upd = updateSmoothedRSI(avgGain, avgLoss, change, RSI_PERIOD);
          avgGain = upd.avgGainNew; avgLoss = upd.avgLossNew; rsiValue = upd.rsiNew;
        }

        lastClose = price;

        // evaluate state machines
        evaluateSlideMachines(price, rsiValue, ema55);

        // update UI
        updateUI(price);

      } catch (e) { console.error('ws message parse', e); }
    };
  } catch (e) {
    console.error('startWebSocket error', e);
    setConn(false);
  }
}

/* ====== Poll fallback every 10s (REST) ====== */
async function pollPriceREST(){
  try {
    const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${SYMBOL}`);
    const d = await res.json();
    const price = parseFloat(d.price);
    if (isNaN(price)) return;
    prevPrice = lastClose; prevRsi = rsiValue;

    closes.push(price);
    if (closes.length > KLINE_LIMIT) closes.shift();

    if (ema55 === null && closes.length >= EMA_PERIOD) ema55 = calcEMAFromArray(closes, EMA_PERIOD);
    else if (ema55 !== null) {
      const k = 2/(EMA_PERIOD+1);
      ema55 = price * k + ema55 * (1-k);
    }

    if (avgGain === null || avgLoss === null) {
      if (closes.length >= RSI_PERIOD+1) {
        const r = calcInitialRSI(closes, RSI_PERIOD);
        avgGain = r.avgGain; avgLoss = r.avgLoss; rsiValue = r.rsi;
      }
    } else {
      const change = lastClose !== null ? (price - lastClose) : 0;
      const upd = updateSmoothedRSI(avgGain, avgLoss, change, RSI_PERIOD);
      avgGain = upd.avgGainNew; avgLoss = upd.avgLossNew; rsiValue = upd.rsiNew;
    }

    lastClose = price;
    evaluateSlideMachines(price, rsiValue, ema55);
    updateUI(price);
  } catch (e) { console.error('pollPriceREST', e); }
}

/* ====== Init ====== */
(async function init(){
  setConn(false);
  $('currentTime').textContent = nowTime();
  await fetchKlines();
  startWebSocket();
  setInterval(pollPriceREST, 10000);
  setInterval(()=>{ $('currentTime').textContent = nowTime(); }, 1000);
})();
</script>
</body>
</html>

